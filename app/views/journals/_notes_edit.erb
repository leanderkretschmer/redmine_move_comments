<div style="margin-top: 15px; padding: 10px; border-top: 1px solid #e0e0e0; background: #fafafa;">
  <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
    <strong><%=h t('label_move_to_issue') %></strong>
    <%= text_field_tag :new_issue_id, '', :placeholder => 'ID...', :style => 'width: 80px; padding: 3px;' %>
    <% if defined?(enable_ticket_search) && enable_ticket_search %>
      <%= text_field_tag :ticket_search, '', :placeholder => t('placeholder_search_tickets'),
                         :style => 'width: 260px; padding: 3px; font-size: 12px;',
                         :autocomplete => 'off',
                         :oninput => 'autocompleteTickets(this.value)' %>
      <div id="ticket-autocomplete" style="position: relative;">
        <div id="ticket-autocomplete-list" style="position: absolute; background: white; border: 1px solid #ddd; width: 260px; max-height: 180px; overflow-y: auto; z-index: 9999; display: none; pointer-events: none;"></div>
      </div>
    <% end %>
  </div>
  
  <% if defined?(show_user_tickets) && show_user_tickets && defined?(user_tickets) && user_tickets.any? %>
    <div style="margin-top: 8px;">
      
      <div id="ticket-list" style="max-height: 120px; overflow-y: auto; border: 1px solid #ddd; background: white;">
        <% user_tickets.each do |ticket| %>
          <div class="ticket-item" style="padding: 4px 8px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 12px;" 
               onclick="document.getElementById('new_issue_id').value='<%= ticket[:id] %>';" 
               onmouseover="this.style.backgroundColor='#e6f3ff';" 
               onmouseout="this.style.backgroundColor='';">
            <div style="font-weight: bold; color: #169;">#<%= ticket[:id] %></div>
            <div style="color: #333; margin-top: 2px;"><%= truncate(ticket[:subject], :length => 45) %></div>
            <% if defined?(show_project_info) && show_project_info && ticket[:project] %>
              <div style="color: #666; font-size: 10px; margin-top: 2px;"><%= ticket[:project] %></div>
            <% end %>
          </div>
        <% end %>
      </div>
      
      <div style="font-size: 10px; color: #666; margin-top: 4px; text-align: center;">
        <%=h t('text_click_to_select_ticket') %>
      </div>
    </div>
  <% end %>
</div>

<% if defined?(enable_ticket_search) && enable_ticket_search %>
<script>
async function autocompleteTickets(term) {
  const list = document.getElementById('ticket-autocomplete-list');
  if (!list) return;
  const trimmed = (term || '').trim();
  if (trimmed.length < 1) {
    list.style.display = 'none';
    list.style.pointerEvents = 'none';
    list.innerHTML = '';
    return;
  }
  try {
    const url = '<%= url_for(:controller => "move_comments_search", :action => "issues") %>' + `?term=${encodeURIComponent(trimmed)}`;
    const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!res.ok) throw new Error('Network error');
    const data = await res.json();
    list.innerHTML = '';
    data.forEach(item => {
      const row = document.createElement('div');
      row.style.padding = '4px 8px';
      row.style.cursor = 'pointer';
      row.style.borderBottom = '1px solid #f0f0f0';
      const title = item.subject || '';
      const project = item.project ? ` — ${item.project}` : '';
      row.textContent = `#${item.id} ${title}${project}`;
      row.onclick = () => {
        document.getElementById('new_issue_id').value = item.id;
        list.style.display = 'none';
        list.innerHTML = '';
      };
      row.onmouseover = () => row.style.backgroundColor = '#e6f3ff';
      row.onmouseout = () => row.style.backgroundColor = '';
      list.appendChild(row);
    });
    list.style.display = data.length ? 'block' : 'none';
    list.style.pointerEvents = data.length ? 'auto' : 'none';
  } catch(e) {
    list.style.display = 'none';
    list.style.pointerEvents = 'none';
    list.innerHTML = '';
  }
}

// Schließe Autocomplete bei Klick außerhalb
document.addEventListener('click', function(e) {
  const list = document.getElementById('ticket-autocomplete-list');
  const input = document.getElementById('ticket_search');
  if (!list) return;
  const isClickInside = list.contains(e.target) || (input && input.contains(e.target));
  if (!isClickInside) {
    list.style.display = 'none';
    list.style.pointerEvents = 'none';
    list.innerHTML = '';
  }
});
</script>
<% end %>